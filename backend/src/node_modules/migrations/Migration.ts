const mongoose = require('mongoose');
const Schema = mongoose.Schema;
const winston = require("winston");
const _wait = require("wait.for");


const _SCHEMA = new Schema({
    version: {type: String, unique: true}
}, { collection: 'Migration' });

const Migration = mongoose.model('Migration', _SCHEMA);

export function BeforeMigrate(name: string) {
    return new Promise((resolve: any, reject: any) => {
        Migration.findOne({version: name}, function(err, resp) {
            if (err) {
                console.log(err);
                reject(err);
            } else if (resp) {                
                reject(`=== Migration ${name} has already been added ===`);
            } else {
                resolve(`=== Migration ${name} will be added ===`);
            }
        })
    });
}

export function AfterMigrate(name: string) {
    return new Promise((resolve: any, reject: any) => {
        const migration = new Migration({
            version: name,
        });
        migration.save(function(err, response) {
            if (err) {
                console.log(err);
                reject(err);
            } else {
                resolve(`=== Migration ${name} has been added successfully ===`);
            }            
        });
    });
}

export function Migrate(migrationName: string, callback: any) {
    return new Promise((resolve: any, reject: any) => {
        _wait.launchFiber(() => {
            BeforeMigrate(migrationName)
            .then((resp) => {
                winston.info(resp);
                
                _wait.launchFiber(() => {
                    const resp = callback();
                    resp.then((r) => {
                        AfterMigrate(migrationName)
                        .then((resp) => {
                            winston.info(resp);
                            resolve('OK')
                        })
                        .catch((err) => {
                            winston.error(err);
                            reject(err);
                        });
                    });                    
                });
                              
            })
            .catch((error) => {
                winston.info(error);
                resolve("OK");
            });   
        });
    }); 
}
